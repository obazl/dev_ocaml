<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="formatting,  notes, tips, cautions, warnings, admonitions">
<title>ppx | The OBazl Book B</title>
<!-- <link rel="stylesheet" href="/css/syntax.css"> -->

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="/docs_obazl/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="/docs_obazl/css/customstyles.css">
<link rel="stylesheet" href="/docs_obazl/css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="/docs_obazl/css/theme-blue.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc-pygments.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/docs_obazl/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<!-- <script src="/docs_obazl/js/toc.js"></script> -->
<script src="/docs_obazl/js/customscripts.js"></script>

<link rel="shortcut icon" href="/docs_obazlimages/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="The OBazl Book" href="/feed.xml">



    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/docs_obazl">&nbsp;<span class="projectTitle"> The OBazl Book</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                <!-- entries without drop-downs appear here -->




                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="https://github.com/tomjoht/documentation-theme-jekyll" target="_blank" rel="noopener">GitHub</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="news">News</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                <!--  -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Jekyll Help<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="https://talk.jekyllrb.com" target="_blank" rel="noopener">Jekyll Talk</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://jekyllrb.com/docs/home/" target="_blank" rel="noopener">Jekyll documentation</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://stackoverflow.com/questions/tagged/jekyll" target="_blank" rel="noopener">Jekyll on Stack Overflow</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://idratherbewriting.com/category-jekyll/" target="_blank" rel="noopener">Jekyll on my blog</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Products<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="mydoc_introduction.html">Jekyll Documentation Theme</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p1_landing_page.html">Product 1</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p2_landing_page.html">Product 2</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!--  -->
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/docs_obazl/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/docs_obazl/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="ppx">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>



<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <a href="">
      
      
      rules_ocaml
    </a>
  </li>
  
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external"> -->
         <!--     <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a> -->
         <!-- </p> -->
         <!-- -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>



            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
          <h1>ppx
          <span id="timestamp">Last updated June 30, 2022</span>
          </h1>
    <!-- { % unless page.toc == false %} -->
    <!-- { % include toc.html %} -->
    <!-- { % endunless %} -->

            <div class="paragraph">
<p>With proper toolchain support, PPX management becomes a little more complicated.</p>
</div>
<div class="paragraph">
<p>When a build target depends on a tool (an executable) that also gets
built, Bazel makes a configuration transition to ensure the tool is
built with the proper toolchain. Since such tools are presumably
intended to run on the build host, the transition is intended to
ensure the toolchain used to build the tool targets the build host.</p>
</div>
<div class="paragraph">
<p>The configuration transition selects a toolchain for building the
tool, and by transitivity that toolchain will be used to build any
dependencies of the tool. This works, but ppx codeps throw a spanner
into the works. PPX codependencies are injected into code transformed
by a PPX executable. That means they must be built using the same
toolchain as the one used for the target whose dependency on the PPX
caused the configuration transition.</p>
</div>
<div class="paragraph">
<p>For example, suppose we are building module <code>A</code> with a native&#8594;vm
toolchain. That means we build A with <code>ocamlc.opt</code>, which is native
compiled (it runs on the build host, which is the local "native" machine)
but emits bytecode (its target host is the OCaml VM).</p>
</div>
<div class="paragraph">
<p>Suppose also that target <code>A</code> has attribute <code>ppx = ":ppx.exe"</code>. This
attribute is marked <code>executable = True</code>, which means it must also be
defined with a <code>cfg</code> property set to either <code>exec</code> or <code>target</code>. The
former tells Bazel to transition to the platform configuration of the
build host; the latter, to that of the target host. For
cross-compilation, setting it to <code>exec</code> prevents the tool from being
built to the target platform. Note that <code>cfg</code> may also be set to a
user-defined transition function.</p>
</div>
<div class="paragraph">
<p>Now <code>ppx.exe</code> will have its own dependencies; they will be built using
the same toolchain selected for building <code>ppx.exe</code>, since the
configuration used to select the toolchain for each target will be the
one set for <code>ppx.exe</code> - which is controlled by the <code>cfg</code> property of
the <code>ppx</code> attribute of the <code>A</code> target. Since we&#8217;re building <code>A</code> with a
cross-compiler (from native to bytecode), the <code>cfg="exec"</code> transition
will set the parameters that select the native&#8594;native toolchain for
building <code>ppx.exe</code> and its dependencies. We&#8217;ll call this the "ppx
toolchain".</p>
</div>
<div class="paragraph">
<p>But now suppose one of those dependencies is a <code>ppx_module</code><sup class="footnote" id="_footnote_ppxmodule">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>:&#8201;&#8212;&#8201;let&#8217;s
call it module <code>PpxB</code> --that injects a dependency into the files it
transforms. For example suppose it injects some code that depends on
module <code>C</code>. Then when <code>ppx.exe</code> (which includes <code>PpxB</code>) transforms a
file, say <code>foo.ml</code>, the result will be a source file whose compilation
depends on <code>C</code>. Which means in turn that module <code>C</code> must be compiled
with the original native&#8594;vm toolchain used to compile module <code>A</code>,
<em>not</em> the native&#8594;native PPX toolchain.</p>
</div>
<div class="paragraph">
<p>With OBazl we express such dependencies using the <code>ppx_codeps</code>
attribute of rule <code>ppx_module</code>. The problem then is that these become
(indirect) dependencies of <code>ppx.exe</code>, which means they will be
compiled with the PPX toolchain, which is native&#8594;native. This won&#8217;t
cause a problem until we try to link <code>A</code> into an executable. The
compiler will complain <code>don&#8217;t know what to do with c.cmxa</code>, since
we&#8217;re using <code>ocamlc.opt</code> which expects to see <code>.cma</code> files on the
command line, not <code>.cmxa</code> files.</p>
</div>
<div class="paragraph">
<p>This is of course a toy example, but this situation would arise in
true cross-compilation scenarios, say where the build host is x86 and
the target host is arm. In that case, the ppx_codeps would be built
with the x86&#8594;x86 toolchain instead of the x86&#8594;arm toolchain, with
the same results.</p>
</div>
<div class="paragraph">
<p>Just to complicate things a little more: ppx module sources themselves may
undergo PPX transformation. So we could have a scenario where we need
to ppx process <code>a.ml</code> using <code>ppxA.exe</code>, which depends on a ppx module
needing ppx transformation by <code>ppxB.exe</code>, which depends on another ppx
module needing transformation by <code>ppxC.exe</code>, and so on.</p>
</div>
<div class="paragraph">
<p>For now we just set <code>cfg = "target"</code>, and that works where the
cross-compile is just between native and bytecode. We can get away
with this because we can always run the PPX executable on either
platform, native or bytecode. So for example if we&#8217;re using the
native&#8594;vm toolchain, we do not need to target the native platform for
our ppx executables, because we can always run the vm. In other words
the VM is always available to us even when we&#8217;re running our tools
natively.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> But this won't work when we get to real cross-compiling like
x86-&gt;arm. For example suppose our local host is x86 and we want to
target ARM. Then we will need an x86-&gt;arm cross-toolchain to serve as
our primary toolchain running on our local build host. But when it
comes time to build PPX executables and run them (on our build host)
to transform source code, we will need a secondary x86-&gt;x86 toolchain.
And we will have to ensure that PPX co-dependencies are built with the
primary x86-&gt;arm toolchain.</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how OBazl plans to address the issue.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We attach a transition function to the <code>ppx</code> attribute (of <code>ocaml_module</code> and <code>ocaml_signature</code>)</p>
<div class="ulist">
<ul>
<li>
<p>the transition function writes the current toolchain config to a pair of build settings</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For ppx codeps we have two scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Precompiled codeps that we import using <code>opam_import</code> (or
<code>ocaml_import</code>). The import rules import both bytecode (<code>.cma</code>) and
native (<code>cmxa</code>) archives. Rule logic reads the toolchain config info
to decide which to integrate into the build.</p>
</li>
<li>
<p>codeps that we need to build. In this case, we have to ensure that
the correct toolchain is selected for ppx codependencies.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We attach another transition function of attr <code>ppx_codeps</code>. By the
time it receives control, the toolchain build settings have been
written (by the <code>ppx</code> transition function), so the <code>ppx_codeps</code>
transition function uses that information to reset the build settings
determining toolchain selection.</p>
</div>
<div class="paragraph">
<p>The build settings recording the toolchain config params are only used
by opam_import? Everywhere else its a matter of toolchain selection,
which is handled by Bazel.</p>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The <code>ppx_module</code> rule is the same as a standard <code>ocaml_module</code> rule, except that it has a <code>ppx_codeps</code> attribute, which <code>ocaml_module</code> does not support, and it delivers a <code>PpxModuleMarker</code> provider. Ppx modules may depend on standard modules, but standard modules cannot depend on ppx modules.
</div>
</div>
        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>



<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="maintenance,  ">
<title>Toolchains | The OBazl Book B</title>
<!-- <link rel="stylesheet" href="/css/syntax.css"> -->

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="/docs_obazl/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="/docs_obazl/css/customstyles.css">
<link rel="stylesheet" href="/docs_obazl/css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="/docs_obazl/css/theme-blue.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc-pygments.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/docs_obazl/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<!-- <script src="/docs_obazl/js/toc.js"></script> -->
<script src="/docs_obazl/js/customscripts.js"></script>

<link rel="shortcut icon" href="/docs_obazlimages/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="The OBazl Book" href="/feed.xml">



    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/docs_obazl">&nbsp;<span class="projectTitle"> The OBazl Book</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                <!-- entries without drop-downs appear here -->




                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="https://github.com/tomjoht/documentation-theme-jekyll" target="_blank" rel="noopener">GitHub</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="news">News</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                <!--  -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Jekyll Help<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="https://talk.jekyllrb.com" target="_blank" rel="noopener">Jekyll Talk</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://jekyllrb.com/docs/home/" target="_blank" rel="noopener">Jekyll documentation</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://stackoverflow.com/questions/tagged/jekyll" target="_blank" rel="noopener">Jekyll on Stack Overflow</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://idratherbewriting.com/category-jekyll/" target="_blank" rel="noopener">Jekyll on my blog</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Products<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="mydoc_introduction.html">Jekyll Documentation Theme</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p1_landing_page.html">Product 1</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p2_landing_page.html">Product 2</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!--  -->
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/docs_obazl/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/docs_obazl/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Toolchains">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>



<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <a href="/docs_obazl/rules-ocaml/user-guide">
      Guide:
      
      rules_ocaml
    </a>
  </li>
  
  
  
  <li class="active">
    <a class="folder"
       title="Topics" href="#">Topics</a>
      <ul class="navlist">
          
          
          
          <li class="sb-navitem"><a title="Accessibility" href="visibility">Accessibility</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Aggregates" href="aggregates">Aggregates</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Aspects" href="aspects">Aspects</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Bootstrapping" href="bootstrapping">Bootstrapping</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Caching" href="caching">Caching</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Compilers" href="compilers">Compilers</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Conditional Builds" href="conditional">Conditional Builds</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configuration" href="configuration">Configuration</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configurable Defaults" href="configurable-defaults">Configurable Defaults</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configuration Profiles" href="profiles">Configuration Profiles</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Conventions" href="obazl-conventions">Conventions</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Dependencies" href="dependencies">Dependencies</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Deployment" href="deployment">Deployment</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Diagnostics" href="diagnostics">Diagnostics</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Executables" href="executables">Executables</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="File Generation" href="file-generation">File Generation</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Interop" href="interop">Interop</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Labels" href="https://bazel.build/concepts/labels" target="_blank" rel="noopener">Labels</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Maintenance" href="maintenance">Maintenance</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Modules" href="modules">Modules</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Namespacing" href="namespacing">Namespacing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Offline development" href="offline">Offline development</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="OPAM" href="opam">OPAM</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Optimization" href="optimization">Optimization</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Packages" href="https://bazel.build/concepts/build-ref#packages" target="_blank" rel="noopener">Packages</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Preprocessing" href="preprocessing">Preprocessing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Profiles" href="profiles">Profiles</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Providers" href="providers">Providers</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="PPX Support" href="ppx">PPX Support</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Querying" href="querying">Querying</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Repositories" href="repositories">Repositories</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Refactoring" href="refactoring">Refactoring</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Separate Compilation" href="separate-compilation">Separate Compilation</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Split Dependencies" href="split-dependencies">Split Dependencies</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Signatures" href="signatures">Signatures</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Stamping" href="stamping">Stamping</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Structures" href="structures">Structures</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Targets" href="https://bazel.build/concepts/build-ref#targets" target="_blank" rel="noopener">Targets</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Testing" href="testing">Testing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Threading" href="threading">Threading</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Toolchains" href="toolchains">Toolchains</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Tools" href="tools">Tools</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Troubleshooting" href="troubleshooting">Troubleshooting</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="user.bazelrc" href="user-bazelrc">user.bazelrc</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Visibility" href="visibility">Visibility</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Workspaces" href="workspaces">Workspaces</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external"> -->
         <!--     <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a> -->
         <!-- </p> -->
         <!-- -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>



            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
          <h1>Toolchains
          <span id="timestamp">Last updated May 5, 2022</span>
          </h1>
    <!-- { % unless page.toc == false %} -->
    <!-- { % include toc.html %} -->
    <!-- { % endunless %} -->

            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The OBazl ruleset defines a toolchain <em>model</em> but it does not provide
any toolchain <em>definitions</em>. To use the ruleset, the user must define
one or more toolchains.</p>
</div>
<div class="paragraph">
<p>The OBazl toolsuite makes this easy. Given an OPAM switch, it will
configure an appropriate toolchain. Normally this will "just work" and
the user will never need to even be aware of the toolchain mechanism.</p>
</div>
<div class="paragraph">
<p>Users can easily define custom toolchain definitions if they wish to
use some other OCaml toolsuite, such as a customized version of the
compiler and tools.</p>
</div>
<div class="paragraph">
<p>TODO: ocamlc v. ocamlc.opt v. ocamlopt v. ocamlopt.opt, etc.</p>
</div>
<div class="paragraph">
<p>TODO: other tools: profiler, flambda, etc.</p>
</div>
<div class="paragraph">
<p>OBazl version 1 depended on the <code>ocamlfind</code> program. It expected to
find the program in a local OPAM installation, and it generated build
commands that used <code>ocamlfind</code> to drive the compiler.</p>
</div>
<div class="paragraph">
<p>Version 2 eliminates this dependency. The OBazl toolchain depends only
on an OCaml toolchain; it does not essentially depend on OPAM. It
generates build commands that directly use the compiler commands
(<code>ocamlc</code>, <code>ocamlopt</code>, etc.).</p>
</div>
<div class="paragraph">
<p>The OCaml toolchain used by the OBazl toolchain must be configured.
Since OPAM-built toolchains are very widely used, version 2 only has
built-in support for such toolchains. Configuration of support for the
OBazl toolchain is handled by the OPAM bootstrapping tool that also
configures OPAM packages for OBazl use; see below for more information
on this.</p>
</div>
<div class="paragraph">
<p>A future version of OBazl will support configuration of arbitrary
OCaml toolchains.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bazel-toolchains">Bazel toolchains</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Toolchains involve:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A toolchain <strong><em>type</em></strong>, defined using the predefined Bazel rule <code>toolchain_type</code>. Bazel convention recommends naming such targets "toolchain_type", and using the package name to convey the language involved; for example, a toolchain type for language "foo" might be defined in package <code>@rules_foo//foo</code>, yielding a toolchain type label (tag) <code>@rules_foo//foo:toolchain_type</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
These are not proper types. The <code>toolchain_type</code> rule does
not buid or deliver anything; it is just a mechanism for declaring a
label that can serve to mark a toolchain as a member of a class of
toolchains.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>An abstract toolchain <strong><em>rule</em></strong>, used to construct concrete
toolchains. Toolchain rules are parameterized by the artifacts
(compilers, linkers, etc) of the toolchain; they produce a
<code>ToolchainInfo</code> provider containing those artifacts. Rules that need
to use a build tool will depend on a toolchain target and extract
the required tool from the <code>ToolchainInfo</code> provider.</p>
</li>
<li>
<p>For each concrete toolchain:</p>
<div class="ulist">
<ul>
<li>
<p>A build target using the abstract toolchain rule, passing specific
tools as arguments;</p>
</li>
<li>
<p>A toolchain "classifier", that associates the concrete toolchain with a toolchain type, and specifies its platform compatibilities;</p>
</li>
<li>
<p>Registration of each toolchain/toolchain type pair.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_declaration-definition-and-selection-of-toolchains">declaration, definition, and selection of toolchains</h3>
<div class="paragraph">
<p><a href="https://bazel.build/docs/toolchains#toolchain-definitions" target="_blank" rel="noopener">defining toolchains</a></p>
</div>
<div class="paragraph">
<p>To define some toolchains for a given toolchain type, you need three things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A language-specific rule representing the kind of tool or tool suite. By convention this rule’s name is suffixed with “_toolchain”.</p>
</li>
<li>
<p>Several targets of this rule type, representing versions of the tool or tool suite for different platforms.</p>
</li>
<li>
<p>For each such target, an associated target of the generic toolchain rule, to provide metadata used by the toolchain framework. This toolchain target also refers to the toolchain_type associated with this toolchain. This means that a given _toolchain rule could be associated with any toolchain_type, and that only in a toolchain instance that uses this _toolchain rule that the rule is associated with a toolchain_type.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The terminology here is a little awkward; we have to kinds of
toolchain rule, the "language-specific rule" and the "generic
toolchain rule".  Also unclear are the distinctions between declaration, definition, and selection of toolchains.</p>
</div>
<div class="paragraph">
<p>To avoid confusion we adopt the following terminology:</p>
</div>
<div class="sect3">
<h4 id="_family-of-toolchains">family of toolchains</h4>
<div class="paragraph">
<p>A "language-specific rule" must produce a <code>ToolchainInfo</code> provider, so
we could call it a "toolchain-info" rule. However, as described below,
such rules implicitly define a family of toolchains, so we will call
them "toolchain-family" rules.</p>
</div>
<div class="paragraph">
<p>Such rules do not, strictly speaking, <em>define</em> a toolchain; it&#8217;s more
of a <em>declaration</em> that generates a definition when provided with
arguments. That is, it declares (defines?) an abstract structure of
tools (and other resources, such as files and directories needed by
the tools), and it is up to the user to <em>define</em> those tools by
applying the rule to a set of arguments. In other words such a rule
defines a <em><strong>family</strong></em> of toolchains.</p>
</div>
<div class="paragraph">
<p>In the following examples we are defining toolchains for a (fictional) programming language named <code>barlang</code>.</p>
</div>
<div class="paragraph">
<p>Consider the example at <a href="https://bazel.build/docs/toolchains#toolchain-definitions" target="_blank" rel="noopener">Defining toolchains</a> (warning: we&#8217;ve changed <code>bar</code> to <code>barlang</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>For our running example, here’s a definition for a barlang_toolchain rule. Our example has only a compiler, but other tools such as a linker could also be grouped underneath it.

def _barlang_toolchain_impl(ctx):
    toolchain_info = platform_common.ToolchainInfo(
        barlangInfo = BarlangInfo(
            compiler_path = ctx.attr.compiler_path,
            system_lib = ctx.attr.system_lib,
            arch_flags = ctx.attr.arch_flags,
        ),
    )
    return [toolchain_info]

// barlang_toolchain = rule(
deftc_barlang = rule(
    implementation = _barlang_toolchain_impl,
    attrs = {
        &quot;compiler_path&quot;: attr.string(),
        &quot;system_lib&quot;: attr.string(),
        &quot;arch_flags&quot;: attr.string_list(),
    },
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>barlang_toolchain</code> does nothing more than wrap some parameters
in a <code>ToolchainInfo</code> structure. It does not <em>define</em> a compiler, for
example; it only <em>declares</em> that each <code>barlang</code> toolchain must define
a <code>compiler_path</code>, etc. In addition, it does <em>not</em> define a toolchain;
rather, it implicitly defines a <em><strong>family</strong></em> of toolchains. The family
is parameterized by the rule attributes; providing a particular set of
attributes selects a member of the family. Thus it is the <em>use</em> of
such a rule that defines (selects) a (concrete) toolchain.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong> A "language-specific" toolchain rule implicitly defines
a family of toolchains (it defines the family, not the toolchains)
but this family is <em>not</em> related to any (toolchain) type defined by a
<code>toolchain_type</code> rule.</p>
</div>
<div class="paragraph">
<p>The standard convention is to name such rules with a "_toolchain"
suffix; this is plainly confusing, since targets defined using such
rules are also appropriately named with the same suffix, not to
mention "instances" of the generic toolchain rule.</p>
</div>
<div class="paragraph">
<p>To use such a rule is to define a toolchain; therefore, to bring this
logic to the surface, we will follow the convention of naming such
rules with prefix <code>deftc_</code> and suffix <code>_toolchain</code>. So when used we will
have <code>deftc_barlang(&#8230;&#8203;)</code> instead of <code>barlang_toolchain(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>To name such toolchains defined using a toolchain-family rule we use
prefix <code>barlang_toolchain</code> (or an unambiguous abbreviation where
possible, e.g. <code>barlang_tc</code>), e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>deftc_barlang(
    name = &quot;barlang_tc_linux&quot;,
    arch_flags = [
        &quot;--arch=Linux&quot;,
        &quot;--debug_everything&quot;,
    ],
    compiler_path = &quot;/path/to/barlang/on/linux&quot;,
    system_lib = &quot;/usr/lib/libbarlang.so&quot;,
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We reserve "toolchain" for the toolchains defined as just described - by parameterizing a toolchain-family rule to select a concrete toolchain.
Note that this is in contrast to standard Bazel usage, which uses the
term "toolchain" somewhat loosely.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong> Do not confuse toolchain definitions and tool
definitions. In our example, we are defining toolchains in package
<code>//barlang_tools</code>, and the tools are named in some manner using <code>barlang</code>.
But a toolchain can use whatever tools you care to define for it. In
our example: the resources used to parameterize <code>deftc_barlang</code>
need not have any relation to <code>barlang_tools</code>. Furthermore, the toolchain
mechanism described here (declaration, definition, selection) does not
<em>build</em> the tools, it only configures/selects tools, which may be
built by other rules, or by processes outside of Bazel.</p>
</div>
<div class="paragraph">
<p>The generic toolchain rule (<code>toolchain</code>, defined by Bazel itself) is
simply misnamed. It neither defines nor declares a toolchain; rather
binds a toolchain-info target (defined by applying <code>deftc_*_toolchain</code>
to args) to a toolchain_type target, and expresses a set of
compatibility constraints governing selection of the (generic
toolchain) rule during toolchain resolution at build time. So we&#8217;ll
call it a "toolchain-selector", and name it using suffix
<code>_toolchain_selector</code> (or <code>_tc_selector</code>). Continuing the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>toolchain(  ## misnamed; should be something like `toolchain_selector` or `toolchain_spec` or the like
    name = &quot;barlang_tc_linux_selector&quot;,  ## not &quot;barlangc_linux_toolchain&quot;
    toolchain = &quot;:barlang_tc_linux&quot;,   ## instead of :barlangc_linux
    toolchain_type = &quot;:toolchain_type&quot;, ## bad; should name the type, e.g. barlang_tools_tc
    exec_compatible_with = [
        &quot;@platforms//os:linux&quot;,
        &quot;@platforms//cpu:x86_64&quot;,
    ],
    target_compatible_with = [
        &quot;@platforms//os:linux&quot;,
        &quot;@platforms//cpu:x86_64&quot;,
    ]
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even this is rather weak, though. A <code>toolchain</code> rule always selects a
toolchain of a particular type (value of the <code>toolchain-type</code>
attribute); why not make that explicit in the target name? To support
this, the first step is to give toolchain types meaningful names,
rather than merely <code>:toolchain_type</code> (which effectively conveys no
information). The convention recommended by Bazel is to always use the
name "toolchain_type" for <code>toolchain_type</code> targets, and to rely on the
package path to distinguish toolchain types, which would give us
toolchain type labels like <code>//foo:toolchain_type</code>,
<code>//barlang:toolchain_type</code>. We think this is a (very) bad idea and instead
recommend choosing a target name that conveys meaningful information; for
example, <code>//foo:foo_tc</code>, <code>//barlang:barlang_tc</code>. That makes the
<code>toolchain_type</code> attribute of the <code>toolchain</code> rule more legible:
<code>toolchain_type = ":barlang_tc"</code> instead of <code>toolchain_type =
":toolchain_type"</code>, which conveys little information.</p>
</div>
<div class="paragraph">
<p>Note that we need not suffix <code>_type</code> to the names of such
targets, any more that we need to suffix it to type names like "int".</p>
</div>
<div class="paragraph">
<p>(A counterargument might be that since <code>:toolchain_type</code> implies
<code>barlang_tools:toolchain_type</code>, there is no missing information. But this
is cumbersome; among other things, it means that such a code fragment
cannot be used out of context (e.g. in documentation) without also
providing the package name. Furthermore, what if more than one
<code>toolchain_type</code> is defined in package <code>//barlang_tools</code>? Of course,
another option is to always use the fully-qualified label of
<code>toolchain_type</code> rules.)</p>
</div>
<div class="paragraph">
<p>Following our conventions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>toolchain_type(name = &quot;barlang_tc&quot;)  ## not &quot;toolchain_type&quot;

# declare (a family of toolchains)
_deftc_barlang_impl(ctx):
    toolchain_info = platform_common.ToolchainInfo(...)
    return [toolchain_info] # effectively defines a family of toolchains

deftc_barlang = rule(
    implementation = _deftc_barlang_impl,
    attrs = {...}

# parameterize deftc_* rule to define (select) some (concrete) toolchains from the family
deftc_barlang(
    name = &quot;barlang_tc_linux&quot;,
    arch_flags = [&quot;--arch=Linux&quot;, &quot;--debug_everything&quot;],
    compiler_path = &quot;/path/to/barlang/on/linux&quot;,
    system_lib = &quot;/usr/lib/libbarlang.so&quot;,
)

deftc_barlang(  ## using a different barlang compiler on linux
    name = &quot;barlang_tc_linux_x&quot;,
    arch_flags = [&quot;--arch=Linux&quot;, &quot;--debug_everything&quot;],
    compiler_path = &quot;/path/to/barlang/x/linux&quot;,
    system_lib = &quot;/usr/lib/libbarlang.so&quot;,
)

deftc_barlang(
    name = &quot;barlang_tc_windows&quot;,
    arch_flags = [&quot;--arch=Windows&quot;],
    compiler_path = &quot;C:\\path\\on\\windows\\barlang.exe&quot;,
    system_lib = &quot;C:\\path\\on\\windows\\barlanglib.dll&quot;,
)

toolchain(
    name = &quot;barlang_tc_linux_selector&quot;,
    toolchain_type = &quot;@foo//barlang:toolchain_type&quot;, toolchain = &quot;:barlang_tc_linux&quot;,
    ... compatibility constraints ...
)
toolchain(
    name = &quot;barlang_tc_linux_x_selector&quot;,
    toolchain_type = &quot;:barlang_tc&quot;, toolchain = &quot;:barlang_tc_linux_x&quot;,
    ... compatibility constraints ...
)
toolchain(
    name = &quot;barlang_tc_windows_selector&quot;,
    toolchain_type = &quot;:barlang_tc&quot;, toolchain = &quot;:barlang_tc_windows&quot;,
    ... compatibility constraints ...
)

register_toolchains(
    &quot;//bar_tools:barlang_tc_linux_selector&quot;,
    &quot;//bar_tools:barlang_tc_linux_x_selector&quot;,
    &quot;//bar_tools:barlang_tc_windows_selector&quot;,
)

## a build rule that uses the toolchain, possibly defined in a different BUILD file
def _barlang_binary_impl(ctx):
    ...
    info = ctx.toolchains[&quot;//barlang_tools:barlang_tc&quot;].barlangcinfo
    ...

barlang_binary = rule(
    implementation = _barlang_binary_impl,
    attrs = {...},
    toolchains = [&quot;//barlang_tools:barlang_tc&quot;]
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>IOW, the toolchain is declared by the toolchain-info rule, defined by
application of the toolchain-info rule, and selected for use by the
toolchain-selector rule.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tool-definition">tool definition</h3>
<div class="paragraph">
<p>Toolchains use tools; they do not define or build them.</p>
</div>
<div class="sect3">
<h4 id="_cross-compilation">cross-compilation</h4>
<div class="paragraph">
<p>[OCaml cross-toolchains and cross-packages](<a href="https://github.com/ocaml-cross/" class="bare">https://github.com/ocaml-cross/</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[opam-cross-windows](<a href="https://github.com/ocaml-cross/opam-cross-windows" class="bare">https://github.com/ocaml-cross/opam-cross-windows</a>)</p>
</li>
<li>
<p>[crosstool-NG](<a href="https://crosstool-ng.github.io/" class="bare">https://crosstool-ng.github.io/</a>)</p>
</li>
<li>
<p>[MXE](<a href="https://mxe.cc/" class="bare">https://mxe.cc/</a>) - M Cross Environment</p>
</li>
<li>
<p>[OMicroB](<a href="https://github.com/stevenvar/OMicroB" class="bare">https://github.com/stevenvar/OMicroB</a>) - OCaml on Microcontroller Boards</p>
</li>
<li>
<p>[OCaPIC](<a href="http://www.algo-prog.info/ocapic/web/index.php?id=ocapic" class="bare">http://www.algo-prog.info/ocapic/web/index.php?id=ocapic</a>) - OCaPIC: Programming PIC microcontrollers in OCaml</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://john-millikin.com/bazel-school/toolchains">Bazel School: Toolchains</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
todo: note on ocamlfind - we don&#8217;t use it, why?
</td>
</tr>
</table>
</div>
</div>
</div>
        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>



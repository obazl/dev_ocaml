<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="dependencies,  ">
<title>Dependencies | The OBazl Book B</title>
<!-- <link rel="stylesheet" href="/css/syntax.css"> -->

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="/docs_obazl/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="/docs_obazl/css/customstyles.css">
<link rel="stylesheet" href="/docs_obazl/css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="/docs_obazl/css/theme-blue.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc-pygments.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/docs_obazl/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<!-- <script src="/docs_obazl/js/toc.js"></script> -->
<script src="/docs_obazl/js/customscripts.js"></script>

<link rel="shortcut icon" href="/docs_obazlimages/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="The OBazl Book" href="/feed.xml">



    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/docs_obazl">&nbsp;<span class="projectTitle"> The OBazl Book</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                <!-- entries without drop-downs appear here -->




                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="https://github.com/tomjoht/documentation-theme-jekyll" target="_blank" rel="noopener">GitHub</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="news">News</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                <!--  -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Jekyll Help<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="https://talk.jekyllrb.com" target="_blank" rel="noopener">Jekyll Talk</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://jekyllrb.com/docs/home/" target="_blank" rel="noopener">Jekyll documentation</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://stackoverflow.com/questions/tagged/jekyll" target="_blank" rel="noopener">Jekyll on Stack Overflow</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://idratherbewriting.com/category-jekyll/" target="_blank" rel="noopener">Jekyll on my blog</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Products<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="mydoc_introduction.html">Jekyll Documentation Theme</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p1_landing_page.html">Product 1</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p2_landing_page.html">Product 2</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!--  -->
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/docs_obazl/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/docs_obazl/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Dependencies">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>



<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <a href="/docs_obazl/rules-ocaml/user-guide">
      Guide:
      
      rules_ocaml
    </a>
  </li>
  
  
  
  <li class="active">
    <a class="folder"
       title="Topics" href="#">Topics</a>
      <ul class="navlist">
          
          
          
          <li class="sb-navitem"><a title="Accessibility" href="visibility">Accessibility</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Aggregates" href="aggregates">Aggregates</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Aspects" href="aspects">Aspects</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Bootstrapping" href="bootstrapping">Bootstrapping</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Caching" href="caching">Caching</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Compilers" href="compilers">Compilers</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Conditional Builds" href="conditional">Conditional Builds</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configuration" href="configuration">Configuration</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configurable Defaults" href="configurable-defaults">Configurable Defaults</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Configuration Profiles" href="profiles">Configuration Profiles</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Conventions" href="obazl-conventions">Conventions</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Dependencies" href="dependencies">Dependencies</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Deployment" href="deployment">Deployment</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Diagnostics" href="diagnostics">Diagnostics</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Executables" href="executables">Executables</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="File Generation" href="file-generation">File Generation</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Interop" href="interop">Interop</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Labels" href="https://bazel.build/concepts/labels" target="_blank" rel="noopener">Labels</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Maintenance" href="maintenance">Maintenance</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Modules" href="modules">Modules</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Namespacing" href="namespacing">Namespacing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Offline development" href="offline">Offline development</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="OPAM" href="opam">OPAM</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Optimization" href="optimization">Optimization</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Packages" href="https://bazel.build/concepts/build-ref#packages" target="_blank" rel="noopener">Packages</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Preprocessing" href="preprocessing">Preprocessing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Profiles" href="profiles">Profiles</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Providers" href="providers">Providers</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="PPX Support" href="ppx">PPX Support</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Querying" href="querying">Querying</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Repositories" href="repositories">Repositories</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Refactoring" href="refactoring">Refactoring</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Separate Compilation" href="separate-compilation">Separate Compilation</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Split Dependencies" href="split-dependencies">Split Dependencies</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Signatures" href="signatures">Signatures</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Stamping" href="stamping">Stamping</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Structures" href="structures">Structures</a></li>
          
          
          
          
          
          
          <li class="x"><a title="Targets" href="https://bazel.build/concepts/build-ref#targets" target="_blank" rel="noopener">Targets</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Testing" href="testing">Testing</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Threading" href="threading">Threading</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Toolchains" href="toolchains">Toolchains</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Tools" href="tools">Tools</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Troubleshooting" href="troubleshooting">Troubleshooting</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="user.bazelrc" href="user-bazelrc">user.bazelrc</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Visibility" href="visibility">Visibility</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Workspaces" href="workspaces">Workspaces</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external"> -->
         <!--     <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a> -->
         <!-- </p> -->
         <!-- -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>



            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
          <h1>Dependencies
          <span id="timestamp">Last updated May 4, 2022</span>
          </h1>
    <!-- { % unless page.toc == false %} -->
    <!-- { % include toc.html %} -->
    <!-- { % endunless %} -->

            <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#_dependency-classes">Dependency classes</a></li>
<li><a href="#_transitivity">transitivity</a></li>
<li><a href="#_discovery-v-normalization-v-optimization">discovery v. normalization v. optimization</a></li>
<li><a href="#_separation-of-concerns-dep-mgmt-v-build">Separation of concerns:  dep mgmt v. build</a></li>
<li><a href="#_configurable-dynamic-deps">Configurable ("dynamic") deps</a></li>
<li><a href="#_ocaml-dependencies">OCaml Dependencies</a>
<ul class="sectlevel1">
<li><a href="#_ppx-dependencies">PPX Dependencies</a>
<ul class="sectlevel2">
<li><a href="#_ppx-codependencies">PPX Codependencies</a></li>
</ul>
</li>
<li><a href="#_dune">Dune</a></li>
</ul>
</li>
<li><a href="#_cc-dependencies">CC dependencies</a>
<ul class="sectlevel1">
<li><a href="#_cc-libraries">CC Libraries</a></li>
<li><a href="#_cc-linkmode">CC Linkmode</a></li>
<li><a href="#_dynamic-loading-plugins">Dynamic Loading ('Plugins')</a></li>
<li><a href="#_static-binaries">Static Binaries</a></li>
<li><a href="#_dependency-cycles">Dependency Cycles</a></li>
<li><a href="#_macos">MacOS</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>TODO: how OBazl manages transitive deps.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dependency-classes">Dependency classes</h3>
<div class="ulist">
<ul>
<li>
<p>direct and indirect</p>
</li>
<li>
<p>module v. interface</p>
</li>
<li>
<p>configurable ("dynamic") deps</p>
</li>
<li>
<p>runtime deps (data v. code)</p>
</li>
<li>
<p>PPX co-dependencies</p>
</li>
<li>
<p>local v. external deps</p>
</li>
<li>
<p>OPAM pkg deps (special case)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_transitivity">transitivity</h3>
<div class="paragraph">
<p>Trickier than it seems, because there are several different kinds of depgraph.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>target depgraph</p>
</li>
<li>
<p>action depgraph</p>
</li>
<li>
<p>module (implementation) depgraph</p>
</li>
<li>
<p>interface depgraph</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depgraphs are fully transitive wrt build actions: when you build a target, its complete depgraph gets built.</p>
</div>
<div class="paragraph">
<p>OTOH, the kind of transitivity involved in constructing build commands
is only partially transitive. Interface depgraphs are treated
differently than imlementation depgraphs.</p>
</div>
<div class="paragraph">
<p>Each <code>ocaml_module</code> target propagates its module depgraph to its
clients. That includes its own interface dep, but excludes the
interface deps of its module deps.</p>
</div>
<div class="paragraph">
<p>For example, suppose A.cmo depends on B.cmo, and A.cmi depends on
B.cmi. A.cmo&#8217;s depgraph will include A.cmi and B.cmo as direct
dependencies. And since B.cmo depends directy on B.cmi, the latter
will be included indirectly in A.cmo&#8217;s depgraph. But A.cmi&#8217;s depgraph
will not be included; only A.cmi will be included in A.cmo&#8217;s depgraph.</p>
</div>
<div class="paragraph">
<p>Now suppose A.cmi depends on C.cmi in addition to B.cmi, but neither
A.cmo nor B.cmo depend C.cmo. [Can this happen?] Then A.cmo depends on
A.cmi, but not C.cmi; iow, it only uses the API declared by A.cmi.
Building A.cmi will ccause C.cmi to be built, but the result need not
be added to the depgraph of A.cmo, because the compiler will not need
to find C.cmo in order to compile A.cmo. It only needs to find A.cmi.</p>
</div>
<div class="paragraph">
<p>To build A, we need B.cmi and B.cmo on the search path. Since A.cmo
depends on B.cmo, and B.cmo depends on B.cmi, &#8230;&#8203; B.cmi must be listed
as an input the the A build action, so it must be provided by the
B.cmo depgraph.  But it is not provided by the A.cmi dep, even though A.cmi depends on B.cmi.</p>
</div>
</div>
<div class="sect2">
<h3 id="_discovery-v-normalization-v-optimization">discovery v. normalization v. optimization</h3>

</div>
<div class="sect2">
<h3 id="_separation-of-concerns-dep-mgmt-v-build">Separation of concerns:  dep mgmt v. build</h3>
<div class="paragraph">
<p>Build tasks involve explicit build commands, but they also always
involve a critical bit of information that is often hidden or only
implicit, namely the graph of the target&#8217;s dependencies. Dependency
management is a well-known pain point for OCaml builds; the entire
dependency graph of a build target must be made available to the
compiler, and for archive and executable targets, must be listed
explicitly on the command line in dependency order. By and large,
managing dependencies by hand is infeasible for all but the most simple
projects.</p>
</div>
<div class="paragraph">
<p>The strategy for managing dependencies adopted by Bazel (and thus
OBazl) is starkly different from that of most other build systems.</p>
</div>
<div class="paragraph">
<p>[FIXME: three points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>finding and listing deps as input to the build</p>
</li>
<li>
<p>transparency of actual depgraphs (inspection using <code>query "deps(&#8230;&#8203;)</code>, <code>aquery</code>, <code>--output_groups=closure</code>, etc.)</p>
</li>
<li>
<p>how OBazl normalizes and propagates depgraphs, advantages compared to dune, e.g. ppx_codeps]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many build systems, Dune included, conflate dependency <em>discovery</em> and
the build process. For example, Makefiles for building OCaml projects
usually run <code>ocamldep</code> to generate <code>.depends</code> files listing
dependencies, and build targets depend on these dynamically generated
files. Dune build stanzas list direct dependencies, but indirect
dependencies are discovered (using <code>ocamldep</code>) and added to the build
dependency graph as part of the build process.</p>
</div>
<div class="paragraph">
<p>By contrast, Bazel enforces a strict separation between dependency
discovery and the build process. All dependencies must be explicitly
enumerated for Bazel before the build process begins; discovering and
adding a dependency in the course of the build process is disallowed.
This is a necessary feature of any hermetic (replicable) build
process: if you want to design a replicable experiment, you start by
fixing the initial conditions. Build systems that allow dynamic
discovery and injection of dependencies cannot guarantee hermeticity.  [WARNING: this is not accurate, to be revised]</p>
</div>
<div class="paragraph">
<p>The downside of having to explicitly enumerate the entire dependency
graph for a project is that you have to explicitly enumerate the
entire dependency graph for the project. But this is obviously a task
that can and should be addressed by a build tool, just as it is for
systems that do this discovery during the build process. The only
difference is that for Bazel we run the dependency discovery tool
<em>before</em> the build process commences, and we record its results and
pass them as input to the build process.</p>
</div>
<div class="paragraph">
<p>Version 2 of OBazl includes tooling that can largely if not entirely
automate the enumeration of dependencies. Currently there are some
cases where it is difficult to discover all dependencies; for example
targets that involve lots of indirection, <code>-open</code> arguments and
<code>include</code> directives in source files. A goal of the OBazl project is
to perfect this tool so that can always emit complete and correct
dependency graphs.</p>
</div>
<div class="paragraph">
<p>Another notable feature of OBazl with respect to dependencies is that
we get correct ordering for free, so to speak. Dependency ordering for
compiler inputs, and for most build tools, is expressed syntactically,
as list ordering (which is in part why managing deps in such systems
is difficult). But OBazl maintains dependencies as a graph structure,
so ordering is expressed as hierarchy. The only way to express a
dependency of A on B is to list B explicitly in the <code>deps</code> attribute
of A; there is no way to express it as the list <code>B A</code>, as one must do
on the compiler command line. In particular, listing <code>["A", "B"] in a
`deps`</code> attribute does not express a dependency of B on A. In fact, it
could be the case that A depends on B (either directly or indirectly),
so when we serialize the graph derived from this list we will get <code>B
A</code>. It follows that dependencies can be listed in any order; you can
list them in alphabetical order if you wish.</p>
</div>
<div class="paragraph">
<p>The critical feature here is that Bazel provides out-of-the-box
support for merging dependency graphs. If your dependencies are
expressed as ordered lists, and you have multiple dependencies, then
you have the task of merging the ordered lists in such a way that
dependency order is maintained, which is non-trivial, since the same
item may occur in different contexts in more than one list. [TODO:
simple example]. Bazel provides a <code>depset</code> facility that handles such
merging automatically and efficiently. OBazl rules use depsets to
manage all dependencies.</p>
</div>
<div class="paragraph">
<p>deps that require special handling by the build engine: runtime data
deps; runtime code deps (plugins); ppx-codeps</p>
</div>
</div>
<div class="sect2">
<h3 id="_configurable-dynamic-deps">Configurable ("dynamic") deps</h3>
<div class="paragraph">
<p>solves same problem as Dune&#8217;s <code>(select &#8230;&#8203; from &#8230;&#8203;)</code> (
    <a href="https://dune.readthedocs.io/en/stable/concepts.html#alternative-dependencies">"alternative dependencies"</a>)</p>
</div>
</div>
<h1 id="_ocaml-dependencies" class="sect0">OCaml Dependencies</h1>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
all direct dependencies must be explicitly listed.
OBazl <em>will not</em> analyse implicit dependencies.  However it <em>will</em>
automatically handle indirect dependencies.
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="_ppx-dependencies">PPX Dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ppx-codependencies">PPX Codependencies</h3>
<div class="paragraph">
<p>Sometimes PPX processing injects dependencies that are needed to
compile the result of a PPX transformation. These are often called
"runtime" dependencies, but OBazl calls them <em>ppx_codependencies</em>,
since they are not in fact runtime dependencies. Runtime dependencies
of a module or executable are needed when that module or executable is
executed. These dependencies do not fit that description.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dune">Dune</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
dune dependencies are expressed as <strong>libraries</strong>, or
<strong>packages</strong>.  In the latter case they are package-manager entitities.
Bazel deps may be individual modules, libraries, archives, etc. but
they are always build targets, not package-manager entities.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I.e. with dune one says "this build depends on that package", which
really means that it depends on compiled entities contained in the
package. With bazel one says "this target depends on that target".
That does not always imply something compiled by bazel; targets may
deliver strings, for example.</p>
</div>
<div class="paragraph">
<p>But in the case of local or immediate deps, there is an ambiguity.</p>
</div>
<div class="paragraph">
<p>Example: <code>src/lib/syncable_ledger</code>.  The dunefile lists a library with
name "syncable_ledger". The directory contains a file named
"syncable_ledger.ml".  So if we depend on "syncable_ledger", what is
the dep, exactly?</p>
</div>
<div class="paragraph">
<p>The problem is that we use (by convention) target label ":foo" for
"foo.ml".  But if the lib name is also "foo" then we want to use
":foo" for the library, not the module.</p>
</div>
<div class="paragraph">
<p>Option: use ":foo_cm" for individual modules/files.  The disadvantage
of this is in label aesthetics.</p>
</div>
<div class="paragraph">
<p>Label concepts and aesthetics: the idea is that we treat each pkg as a
conceptual unit, and the directory name as the concept name. So we get
labels like "foo/bar:bar", which abbreviates to "foo/bar".  The
package may have additional targets, e.g. "foo/bar:baz", but the core
concept of the package is captured by the name "foo/bar".</p>
</div>
<div class="paragraph">
<p>Normally (?) a package will correspond to a library/archive containing
multiple modules.  The tricky bit, with dune, is that the library name
may match a module name.  This requires some renaming and module
aliasing.</p>
</div>
<div class="paragraph">
<p>Another option: use a naming convention for libs and archives,
e.g. "foo_lib" and "foo_archive".  But this prevents naming as above,
i.e. we would have foo/bar:bar_lib instead of just foo/bar.</p>
</div>
<div class="paragraph">
<p>Rule of thumb: use same name for directory and for library/archive
target, which should be the concept name. For modules in the
lib/archive (i.e. source files in the dir), use :_Filename (only
visible within the package) or :Filename (if the target is used
outside the package).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
ocamldep lists deps as module names. It doesn&#8217;t have any idea
of library or package.
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_cc-dependencies" class="sect0">CC dependencies</h1>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Support for C/C++ deps is still under development. What&#8217;s
  there works but the interface will likely change since there are
  still some issues to be worked out, such as how best to support
  different link modes and options for each CC dependency.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A "CC dependency" is usually a C/C++ library, but CC dependencies need
not necessarily be produced from C/C++ source code. Rather the term refers
to the standard file format for object files, archives, etc., which is
historically is closely associated with C. Many other languages
(including OCaml, Rust, Go, etc.) are capable of producing such files;
OBazl uses 'CC' terminology (e.g. <code>CC library</code>, <code>cc_deps</code>) to refer to
such files no matter what language was used to produce them.</p>
</div>
<div class="sect1">
<h2 id="_cc-libraries">CC Libraries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A library is a collection of code units. CC libraries come in
several flavors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an unpackaged collection of object files (with <code>.o</code> extension)</p>
</li>
<li>
<p>a <em>static</em> 'library': a collection of code units (object files)
packaged as an <em>archive</em> file, whose extension (by convention) is
<code>.a</code>.</p>
</li>
<li>
<p>a <em>dynamic shared</em> 'library': code units (object files) packaged as
a <em>dynamic shared object</em> (DSO) file. Yes, the terminology conflates
two distinct concepts; OBazl generally treats 'dynamic' and 'shared'
as synonyms. On Linux, these are <code>.so</code> files; on MacOS, they are
<code>.dylib</code> files (but MacOS also supports <code>.so</code> files).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cc-linkmode">CC Linkmode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rules producing CC libs commonly produce both a static archive (<code>.a</code>
files) and one or more shared libraries (<code>.so</code> or <code>.dylib</code> files). In
Obazl rules, <em>link mode</em> determines which type of library is used for
linking. Possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>static</code>: statically link to <code>.a</code> file.</p>
</li>
<li>
<p><code>dynamic</code>: depending on the OS, link to <code>.dylib</code> file (MacOS) or <code>.so</code> file (Linux or MacOS).</p>
</li>
<li>
<p><code>shared</code>: synonym for 'dynamic'</p>
</li>
<li>
<p><code>default</code>: 'static' on Linux, 'dynamic' on MacOS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> The 'default' linkmode is configurable. The default value
  for linkmode 'default' is as noted above. To override the default
  for all rules, pass command-line option <code>--@ocaml//linkmode</code>; for
  example, to set default value for linkmode 'default' to 'dynamic'
  pass <code>--@ocaml//linkmode:dynamic</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic-loading-plugins">Dynamic Loading ('Plugins')</h2>
<div class="sectionbody">
<div class="paragraph">
<p>[TODO: document dynamic loading of CC deps; compare OCaml *.cmxs
files. Distinction between linking and loading.]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_static-binaries">Static Binaries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Executable binaries can be linked in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dynamic - all deps are shared libs</p>
</li>
<li>
<p>Partially static - non-system libs may be statically linked, but system libs are dynamically linked</p>
</li>
<li>
<p>Fully static&#8201;&#8212;&#8201;all dependencies, including system libraries, are statically linked, resulting in a complete standalone executabe.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>WARNING</strong> MacOS does not support statically linked executables. See <a href="https://developer.apple.com/library/archive/qa/qa1118/_index.html" target="_blank" rel="noopener">Statically linked binaries on Mac OS X</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency-cycles">Dependency Cycles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Legacy packages may include circular or mutual dependencies. Bazel
disallows such dependencies.</p>
</div>
<div class="paragraph">
<p>Example: libfqfft/evaluation_domain/domains and libfqfft/polynomial_arithmetic are mutually dependent.</p>
</div>
<div class="paragraph">
<p>In this case listing each in the deps attribute of the other will
fail, since Bazel will detect the dependency cycle.</p>
</div>
<div class="paragraph">
<p>The "proper" way to address this is to refactor the packages to
eliminate the cycles.  But we cannot do that with legacy code we do
not control.</p>
</div>
<div class="paragraph">
<p>The workaround seems to be to use 'include_prefix' &#8230;&#8203;  This will make
compilation work, at the cost of removing at least one of the
dependencies, so a change in one will not force a recompile of the
other.  [Why does this work?]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_macos">MacOS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Linking dynamic libs to an executable on MacOS is an open issue. The
workaround for now is to link to static libs.</p>
</div>
<div class="paragraph">
<p>Demo: [demos/interop/cc_deps]()</p>
</div>
<div class="paragraph">
<p>Resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://blogs.oracle.com/dipol/dynamic-libraries,-rpath,-and-mac-os">Dynamic Libraries, RPATH, and Mac OS</a> Blog article from 2008, still useful.</p>
</li>
<li>
<p><a href="https://github.com/bazelbuild/bazel/blob/master/tools/cpp/osx_cc_wrapper.sh">osx_cc_wrapper.sh</a></p>
</li>
</ul>
</div>
</div>
</div>
        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>



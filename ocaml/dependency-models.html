<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="ocamlbuild,  notes, tips, cautions, warnings, admonitions">
<title>Depencency Models | The OBazl Book B</title>
<!-- <link rel="stylesheet" href="/css/syntax.css"> -->

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="/docs_obazl/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="/docs_obazl/css/customstyles.css">
<link rel="stylesheet" href="/docs_obazl/css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="/docs_obazl/css/theme-blue.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc.css">
<link rel="stylesheet" href="/docs_obazl/css/asciidoc-pygments.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/docs_obazl/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<!-- <script src="/docs_obazl/js/toc.js"></script> -->
<script src="/docs_obazl/js/customscripts.js"></script>

<link rel="shortcut icon" href="/docs_obazlimages/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="The OBazl Book" href="/feed.xml">



    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/docs_obazl">&nbsp;<span class="projectTitle"> The OBazl Book</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                <!-- entries without drop-downs appear here -->




                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="https://github.com/tomjoht/documentation-theme-jekyll" target="_blank" rel="noopener">GitHub</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- <li><a href="news">News</a></li> -->
                <!--  -->
                <!--  -->
                <!--  -->
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                <!--  -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Jekyll Help<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="https://talk.jekyllrb.com" target="_blank" rel="noopener">Jekyll Talk</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://jekyllrb.com/docs/home/" target="_blank" rel="noopener">Jekyll documentation</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://stackoverflow.com/questions/tagged/jekyll" target="_blank" rel="noopener">Jekyll on Stack Overflow</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="http://idratherbewriting.com/category-jekyll/" target="_blank" rel="noopener">Jekyll on my blog</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Products<b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="mydoc_introduction.html">Jekyll Documentation Theme</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p1_landing_page.html">Product 1</a></li> -->
                <!--          -->
                <!--          -->
                <!--          -->
                <!--         <li><a href="p2_landing_page.html">Product 2</a></li> -->
                <!--          -->
                <!--          -->
                <!--     </ul> -->
                <!-- </li> -->
                <!--  -->
                <!--  -->
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/docs_obazl/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/docs_obazl/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Depencency Models">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>



<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <a href="/docs_obazl/ocaml">
      OCaml
      
    </a>
  </li>
  
  
  
  <li class="active">
    <a class="folder"
       title="Topics" href="#">Topics</a>
      <ul class="navlist">
          
          
          
          <li class="sb-navitem"><a title="Language" href="language">Language</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Toolchains" href="toolchains">Toolchains</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Dependency Models" href="dependency-models">Dependency Models</a></li>
          
          
          
          
          
          
          <li class="sb-navitem"><a title="Build Discipline" href="build-discipline">Build Discipline</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external"> -->
         <!--     <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a> -->
         <!-- </p> -->
         <!-- -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>



            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
          <h1>Depencency Models</h1>
    <!-- { % unless page.toc == false %} -->
    <!-- { % include toc.html %} -->
    <!-- { % endunless %} -->

            <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_concepts-and-terminology">Concepts and Terminology</a></li>
<li><a href="#_build-action-dependencies">Build Action Dependencies</a>
<ul class="sectlevel2">
<li><a href="#_compilation">Compilation</a></li>
<li><a href="#_signatures">Signatures</a></li>
<li><a href="#_structures">Structures</a></li>
<li><a href="#_modules">Modules</a></li>
</ul>
</li>
<li><a href="#_module-dependencies">Module Dependencies</a>
<ul class="sectlevel2">
<li><a href="#_principal-api">Principal API</a></li>
<li><a href="#_principal-spi">Principal SPI</a></li>
</ul>
</li>
<li><a href="#_cross-module-optimization">Cross-module Optimization</a></li>
<li><a href="#_references">References</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Status: initial draft
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dependency managment for OCaml builds is rather complex. OCaml builds
involve multiple dependency graphs that, while related, must be
managed separately.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts-and-terminology">Concepts and Terminology</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>API v. SPI</p>
</li>
<li>
<p>provider v. consumer</p>
</li>
<li>
<p>direct v. indirect deps</p>
</li>
<li>
<p>compile-time v. link-time deps</p>
</li>
<li>
<p>sig deps v. struct deps</p>
</li>
<li>
<p>build actions: compile, archive, link</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>API: an OCaml signature, composed of fields</p>
</div>
<div class="paragraph">
<p>API provider: an OCaml struct</p>
</div>
<div class="paragraph">
<p>SPI: a library composed of (compiled) signatures</p>
</div>
<div class="paragraph">
<p>SPI provider: a collection of (compiled) modules and sigs?</p>
</div>
<div class="paragraph">
<p>NB: SPI provider is a build concept. The OCaml language does not
define either "library" or "archive"; it has no first-class concept
corresponding to "SP provider".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An API provider (i.e. an OCaml struct) must provide <em>at least</em> the fields listed in the API;</p>
</li>
<li>
<p>An API consumer (i.e. an OCaml struct?) may reference <em>at most</em> the fields listed in the API;</p>
</li>
<li>
<p>An SPI provider (i.e. a library) must provide <em>at least</em> the modules listed in the SPI;</p>
</li>
<li>
<p>An SPI consumer (i.e. an OCaml struct?) may reference <em>at most</em> the modules listed in the SPI.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build-action-dependencies">Build Action Dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_compilation">Compilation</h3>

</div>
<div class="sect2">
<h3 id="_signatures">Signatures</h3>

</div>
<div class="sect2">
<h3 id="_structures">Structures</h3>

</div>
<div class="sect2">
<h3 id="_modules">Modules</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_module-dependencies">Module Dependencies</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Remember that OCaml has two type systems, one for modules
and one for everything else. When referring to modules, <em>type</em> means
<em>module type</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A module is a <em>binding</em>: a pairing of a signature and a structure,
where the latter <em>satisfies</em> the former. It follows that modules have
two dependency graphs.</p>
</div>
<div class="paragraph">
<p>The meaning of "module A depends on module B" is surprisingly complicated.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Compiler perspective</dt>
<dd>
<p>The structure component of
module A directly depends on the signature of module B.</p>
</dd>
<dt class="hdlist1">Linker perspective</dt>
<dd>
<p>The compiled <em>structure</em> component of module A
depends on the compiled <em>structure</em> component of module B.</p>
</dd>
<dt class="hdlist1">Build system perspective</dt>
<dd>
<p>Different build systems may handle module
dependencies in different ways. The OCaml compiler requires that
signatures be compiled before structures, which makes structures
dependent on signatures <em>for compilation</em>. For <em>dependency
resolution</em> this is reversed: the depending (structure component of
the) module depends on the signature component of its dependency, and
in fact does not even depend on the structure component (that
dependency only takes effect for the link action). So a build system
has various ways to interpret "A depends on B". It could record a
compile-dependency of struct A on sig B and a separate
link-dependency of struct A on struct B, for example.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is where another distinction between dependency graph types is in
order. Build languages allow the expression of dependencies; in OBazl
we call those "target dependencies". But the build program must
distinguish between such target dependencies and the dependencies of
build actions, which are not necessarily the same thing.</p>
</div>
<div class="paragraph">
<p>For example, given "A depends on B", the target depgraph (for A) will
contain both struct B and sig B (with the former dependent on the
latter). But the depgraph of the <em>compile action</em> for A will include
sig B but not struct B, and the depgraph of any <em>link action</em> that
includes A will include struct B but not sig B.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"Module A depends on module B" does <em>not</em> mean that the
signature of module A depends on the signature of module B. That may
be the case, but it is not entailed by the module dependency.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Dependency of target A on target B does <em>not</em> imply dependency
of A actions on B actions!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_principal-api">Principal API</h3>
<div class="paragraph">
<p>Every structure has a <em>principal API</em>, which is expressed by its
<em>principal (module) type</em> (a/k/a principal signature).</p>
</div>
<div class="paragraph">
<p>Every module has a public API, expressed by its signature component.
The public API of a module is a subset of the principal API of its
structure component.</p>
</div>
<div class="paragraph">
<p>The principal API of a structfile may be extracted from its source
code using the <code>-i</code> switch of the compiler.  [TODO: cross-ref]</p>
</div>
</div>
<div class="sect2">
<h3 id="_principal-spi">Principal SPI</h3>
<div class="paragraph">
<p>Every structure (implementation component of a module) has a <em>Service
Programming Interface (SPI)</em>. The SPI is composed of all the modules
directly referenced by the code of the structure. It represents the
collection of services that must be provided (by the environment, in
practice the build system) in order for the structure (module) to
compile and function.</p>
</div>
<div class="paragraph">
<p>SPIs are conceptual; unlike APIs, which are encoded as <code>.mli/.cmi</code>
files, SPIs have no formal representation in either the language or
any build systems that I know of. But they are expressed in build
languages as dependency lists.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">minimal SPI</dt>
<dd>
<p>the least set of dependencies sufficient for compilation</p>
</dd>
<dt class="hdlist1">principal SPI</dt>
<dd>
<p>one dep for each explicit ref in the source, without duplicates</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Building a module involves (symmettrically) <em>satisfying</em> both the API and the SPI.</p>
</div>
<div class="paragraph">
<p>To build a module, we bind its signature to a structure that <em>satisfies</em> the signature.</p>
</div>
<div class="paragraph">
<p>To compile a structure, we need to "bind its SPI" (so to speak) to a
"structure" of modules (dependencies). In practice what this means is
we need to make available to the compiler whatever modules it needs to
resolve symbols in the structfile. But structurally it&#8217;s just like
binding a structure to a signature, where the structure makes
available whatever is needed to define the symbols in the signature.</p>
</div>
<div class="paragraph">
<p>So by analogy we will call a collection of modules satisfying a structure&#8217;s SPI a "depstruct" (???)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cross-module-optimization">Cross-module Optimization</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ocaml/RFCs/pull/31">Add -Ihidden in addition to -I for avoiding transitive dependencies in the initial scope #31</a></p>
</li>
</ul>
</div>
</div>
</div>
        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>


